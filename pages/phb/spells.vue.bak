<template lang="pug">
  div
    h1.sr-only Mass Effect 5e - Player's Handbook

    // Main toolbar
    main-toolbar.hidden-sm-and-down
    phb-toolbar(v-if="!searchActive").hidden-md-and-up
      h2(slot="toolbarTitle").title Spells
      template(slot="toolbarItems")
        v-btn(icon @click="searchActive = true") #[v-icon search]
        v-btn(icon @click="mobileFilters = true")  #[v-icon filter_list]

    // Search Toolbar
    v-toolbar(light v-if="searchActive").hidden-md-and-up
      v-btn(@click="searchActive = false; searchString = ''" icon) #[v-icon arrow_back]
      v-text-field(v-model="searchString" single-line full-width hide-details label="Search")

    // Content
    v-content.blue-grey.lighten-4
      v-container(:class="{ 'px-0': $vuetify.breakpoint.xsOnly }" )

        // Search functions for large screens
        div.hidden-sm-and-down
          h2.display-1 Spells
          v-layout(row wrap)
            v-flex(md4).px-1
              v-text-field(append-icon="search" label="Search" single-line hide-details v-model="searchString")
            v-flex(md8).px-1
              spell-filters

        // Spell List
        spell-expansion-list(:spells="filtered")

    // Mobile Search filters
    v-dialog(v-model="mobileFilters" fullscreen hide-overlay transition="dialog-bottom-transition" v-if="$vuetify.breakpoint.smAndDown")
      v-card
        v-toolbar(dark color="primary")
          v-btn(icon dark @click.native="mobileFilters = false") #[v-icon close]
          v-toolbar-title Filter Spells
        v-card-text
          spell-filters
</template>

<script>
  import MainToolbar from '~/components/MainToolbar.vue'
  import PhbToolbar from '~/components/PhbToolbar.vue'
  import SpellExpansionList from '~/components/spell/SpellExpansionList.vue'
  import SpellFilters from '~/components/spell/SpellFilters.vue'
  import {mapGetters, mapActions} from 'vuex'

  export default {
    components: {
      MainToolbar,
      PhbToolbar,
      SpellExpansionList,
      SpellFilters
    },
    computed: {
      ...mapGetters(['getData']),
      ...mapGetters('spellList', {
        order: 'order',
        sortBy: 'sortBy',
        type: 'type',
        availableClasses: 'availableClasses'
      }),
      filtered () {
        let data = this.items
        let sortBy = this.sortBy.key
        let order = this.order
        data.sort(function (a, b) {
          switch (sortBy) {
            case 'type':
              if (a[sortBy] === b[sortBy]) {
                if (a.level === b.level) {
                  return (a.name > b.name ? 1 : -1) * order
                } else {
                  return (a.level > b.level ? 1 : -1) * order
                }
              } else {
                return (a[sortBy] > b[sortBy] ? 1 : -1) * order
              }
            default:
              return (a[sortBy] === b[sortBy] ? 0 : a[sortBy] > b[sortBy] ? 1 : -1) * order
          }
        })
        if (this.searchString) {
          data = data.filter((spell) => {
            let nameMatch = spell.name.toLowerCase().indexOf(this.searchString.toLowerCase()) >= 0
            let textMatch = spell.mechanic_text_dump.indexOf(this.searchString.toLowerCase()) >= 0
            return nameMatch || textMatch
          })
        }
        if (this.type.length > 0) {
          data = data.filter(spell => this.type.includes(spell.type))
        }
        if (this.availableClasses.length > 0) {
          data = data.filter(spell => {
            for (const c of this.availableClasses) {
              if (spell[c]) {
                return spell
              }
            }
          })
        }
        return data
      }
    },
    created () {
      this.items = this.getData('spells')
    },
    data () {
      return {
        items: [],
        mobileFilters: false,
        searchActive: false,
        searchString: ''
      }
    },
    head () {
      return {
        title: 'Mass Effect 5e | Biotics, Tech and Combat Powers',
        meta: [
          { hid: 'description', name: 'description', content: 'Dozens of unique and re-skinned D&D spells are available as Biotic, Tech, and Combat powers' }
        ]
      }
    },
    layout: 'cyo',
    methods: {
      ...mapActions(['spellList/updateValue', 'spellList/getValue'])
    }
  }
</script>
